name: Sync to Vercel Repository

on:
  push:
    branches:
      - main
      - master

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.VERCEL_REPO_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Add target repository as remote
        run: |
          git remote add target https://x-access-token:${{ secrets.VERCEL_REPO_TOKEN }}@github.com/amzdudesai02-rgb/amzdudes.git

      - name: Verify repository access
        run: |
          if ! git ls-remote target; then
            echo "❌ Repository not accessible. Please check:"
            echo "   1. Repository 'amzdudesai02-rgb/amzdudes' exists"
            echo "   2. VERCEL_REPO_TOKEN secret is set in repository settings"
            echo "   3. Token has 'repo' scope and write access to target repository"
            exit 1
          else
            echo "✅ Repository access verified"
          fi

      - name: Fetch target repository
        run: |
          git fetch target main || echo "Target branch doesn't exist yet, will create it"

      - name: Remove .github directory (not needed for Vercel repo)
        run: |
          rm -rf .github

      - name: Configure Git for push
        run: |
          # Get the original commit author from the latest commit
          ORIGINAL_AUTHOR=$(git log -1 --format='%an')
          ORIGINAL_EMAIL=$(git log -1 --format='%ae')
          git config user.name "$ORIGINAL_AUTHOR"
          git config user.email "$ORIGINAL_EMAIL"
          
          # Ensure we're on a branch (not detached HEAD)
          git checkout -B sync-branch || git checkout -b sync-branch
          
          # Stage all changes including deletions
          git add -A
          
          # Commit changes if there are any
          if ! git diff --cached --quiet || ! git diff --quiet; then
            git commit -m "Sync from junaid3321/amzdudes"
            echo "✅ Changes committed"
          else
            echo "ℹ️ No changes to commit"
          fi

      - name: Push to target repository
        run: |
          echo "Pushing to target repository..."
          # Push the current branch to target's main branch
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if git push target ${CURRENT_BRANCH}:main --force; then
            echo "✅ Successfully synced to target repository"
          else
            echo "❌ Failed to push to target repository"
            echo "Check the error above for details"
            exit 1
          fi
        env:
          GIT_ASKPASS: echo
          GIT_TERMINAL_PROMPT: 0

